---
layout: post
title: New SiteAvailabilityHttpModule - Based on Client IP Address
date: 
type: post
parent_id: '0'
published: false
password: ''
status: draft
categories: []
tags: []
meta:
  blogger_blog: toddmeinershagen.blogspot.com
  blogger_author: Todd Meinershagen
  blogger_afd108f81ae242501ffa65d49d9298e0_permalink: '3943235495353658183'
  _publicize_job_id: '11181718719'
author:
  login: tmeinershagen
  email: todd@meinershagen.net
  display_name: Todd Meinershagen
  first_name: ''
  last_name: ''
---
<div class="Section1">
<p class="MsoNormal">As part of my company’s Technical Council, we are working on defining our process for promoting code from one environment to the next.  One of the items we wanted to standardize across our enterprise was how we stop a site during a promotion.  </p>
<p class="MsoNormal">ASP.NET 2.0 has a nice feature for shutting down a site called App Offline.  As Scott Guthrie from Microsoft puts it, “the way [App Offline] works is that you place this file in the root of the application.  When ASP.NET sees it, it will shut-down the app-domain for the application (and not restart it for requests) and instead send back the contents of the app_offline.htm file in response to all new dynamic requests for the application.  When you are done updating the site, just delete the file and it will come back online.”  You can find more out about this technique from the original blog entry <a href="http://weblogs.asp.net/scottgu/archive/2006/04/09/442332.aspx">here</a>.</p>
<p class="MsoNormal">Unfortunately, our requirements were a bit more complicated than was intended with the app_offline.htm.  First, most of our applications were written with the 1.1 framework, so this built-in functionality was not available for our use.  In addition, we wanted the ability for testers to be able to validate the site once the changes had been made.  However, we didn’t want to have to bring the site back up in order to do that.</p>
<p class="MsoNormal">As I was looking on line, I found another option called the <a href="http://www.jameskovacs.com/blog/InDepthLookAtTheSiteAvailabilityModule.aspx">SiteAvailabilityHttpModule</a>.  This module allowed for the site to be shut down by merely configuring an HttpModule within the web.config.  In the Init() event, the module subscribes to the PostAuthorizeRequest event.  Within the event handler, the system determines whether or not the request occurred during an accepted time frame and whether or not the requesting user belonged to the administrator role.  </p>
<p class="MsoNormal">We didn’t need either of those features for our deployment.  Instead of using a role-based mechanism for determining a user’s access, we wanted to base access on a configured list of client IP addresses.  As a result, we didn’t need to wait until the PostAuthorizeRequest event – we could check these aspects within the first event – BeginRequest instead.  The code is listed below. </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:consolas;"></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:consolas;">void</span><span style="font-size:10pt;font-family:consolas;"> context_BeginRequest(<span style="color:blue;">object</span> sender, EventArgs e)</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;"></span><span style="font-size:10pt;font-family:consolas;">{</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;"><span style="color:blue;"><font color="#000000">     </font>string</span> ext = Path.GetExtension(HttpContext.Current.Request.Path).ToLower();</span><span style="font-size:10pt;font-family:consolas;">              </span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;">     </span><span style="font-size:10pt;font-family:consolas;"><span style="color:blue;">if</span>(ext == ".aspx") </span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;">     </span><span style="font-size:10pt;font-family:consolas;">{</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;">          <span style="color:blue;">if</span> (<span style="color:blue;">this</span>.IsEnabled)</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;">          {</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;">               <span style="color:blue;">if</span> (!IsClientIPValid())</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;">               {</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;">                    HttpContext.Current.RewritePath("~/SiteUnavailable.htm");</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;">               }</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;">          }</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;">     }</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;">}</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;"></span></p>
<p class="MsoNormal">Notice that you must place a SiteUnavailable.htm file at the root of the site in order to display content if the user’s client IP address does not match one that is configured in the web.config.  You can find the current release for this component <a href="http://meinershagen.net/community/files/folders/files_ewh_releases/entry155.aspx">here</a>.</p>
</p></div>
<div class="blogger-post-footer">
<div>
<br />
<span style="border-top:solid 1px #000000;"><br />
<span style="text-align:left;"><br />
Todd Meinershagen is a Principal Consultant with </span><a href="http://www.improvingenterprises.com/" style="text-align:left;">Improving Enterprises</a><span style="text-align:left;"> in Dallas, Texas.</span><br />
</span><br />

</div>
</div>
