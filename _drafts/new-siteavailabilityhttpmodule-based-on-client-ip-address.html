---
layout: post
title: New SiteAvailabilityHttpModule - Based on Client IP Address
date: 
type: post
parent_id: '0'
published: false
password: ''
status: draft
categories: []
tags: []
meta:
  _edit_last: '2295558'
  _publicize_job_id: '11181718597'
author:
  login: tmeinershagen
  email: todd@meinershagen.net
  display_name: Todd Meinershagen
  first_name: ''
  last_name: ''
---
<div class="Section1">
<p class="MsoNormal">As part of my company’s Technical Council, we are working on defining our process for promoting code from one environment to the next.&nbsp; One of the items we wanted to standardize across our enterprise was how we stop a site during a promotion.&nbsp; </p>
<p class="MsoNormal">ASP.NET 2.0 has a nice feature for shutting down a site called App Offline.&nbsp; As Scott Guthrie from Microsoft puts it, “the way [App Offline] works is that you place this file in the root of the application.&nbsp; When ASP.NET sees it, it will shut-down the app-domain for the application (and not restart it for requests) and instead send back the contents of the app_offline.htm file in response to all new dynamic requests for the application.&nbsp; When you are done updating the site, just delete the file and it will come back online.”&nbsp; You can find more out about this technique from the original blog entry <a href="http://weblogs.asp.net/scottgu/archive/2006/04/09/442332.aspx">here</a>.</p>
<p class="MsoNormal">Unfortunately, our requirements were a bit more complicated than was intended with the app_offline.htm.&nbsp; First, most of our applications were written with the 1.1 framework, so this built-in functionality was not available for our use.&nbsp; In addition, we wanted the ability for testers to be able to validate the site once the changes had been made.&nbsp; However, we didn’t want to have to bring the site back up in order to do that.</p>
<p class="MsoNormal">As I was looking on line, I found another option called the <a href="http://www.jameskovacs.com/blog/InDepthLookAtTheSiteAvailabilityModule.aspx">SiteAvailabilityHttpModule</a>.&nbsp; This module allowed for the site to be shut down by merely configuring an HttpModule within the web.config.&nbsp; In the Init() event, the module subscribes to the PostAuthorizeRequest event.&nbsp; Within the event handler, the system determines whether or not the request occurred during an accepted time frame and whether or not the requesting user belonged to the administrator role.&nbsp; </p>
<p class="MsoNormal">We didn’t need either of those features for our deployment.&nbsp; Instead of using a role-based mechanism for determining a user’s access, we wanted to base access on a configured list of client IP addresses.&nbsp; As a result, we didn’t need to wait until the PostAuthorizeRequest event – we could check these aspects within the first event – BeginRequest instead.&nbsp; The code is listed below. </p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:consolas;"></span></p>
<p class="MsoNormal"><span style="font-size:10pt;color:blue;font-family:consolas;">void</span><span style="font-size:10pt;font-family:consolas;"> context_BeginRequest(<span style="color:blue;">object</span> sender, EventArgs e)</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;"></span><span style="font-size:10pt;font-family:consolas;">{</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;"><span style="color:blue;"><font color="#000000">&nbsp;&nbsp;&nbsp;&nbsp; </font>string</span> ext = Path.GetExtension(HttpContext.Current.Request.Path).ToLower();</span><span style="font-size:10pt;font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:10pt;font-family:consolas;"><span style="color:blue;">if</span>(ext == ".aspx") </span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp; </span><span style="font-size:10pt;font-family:consolas;">{</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue;">if</span> (<span style="color:blue;">this</span>.IsEnabled)</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:blue;">if</span> (!IsClientIPValid())</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HttpContext.Current.RewritePath("~/SiteUnavailable.htm");</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;">&nbsp;&nbsp;&nbsp;&nbsp; }</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;">}</span></p>
<p class="MsoNormal"><span style="font-size:10pt;font-family:consolas;"></span></p>
<p class="MsoNormal">Notice that you must place a SiteUnavailable.htm file at the root of the site in order to display content if the user’s client IP address does not match one that is configured in the web.config.&nbsp; You can find the current release for this component <a href="http://meinershagen.net/community/files/folders/files_ewh_releases/entry155.aspx">here</a>.</p>
</div>
